trigger:
  branches:
    include:
      - master
      - feature/*
      - feature/XPLSG-*

pool:
  vmImage: ubuntu-latest

stages:
  # ================= Docker Build & Push ===================
  - stage: Docker_Build_And_Push
    displayName: "Build & Push Docker Images"
    jobs:
      - job: Build_And_Push
        displayName: "Build & Push to Azure Container Registry (ACR)"
        steps:
          - checkout: self

          - script: |
              docker build -t xplsg-frontend:latest ./frontend
              docker build -t xplsg-auth-service:latest ./backend/services/auth
            displayName: "Build Docker Images"

          - script: |
              docker tag xplsg-frontend:latest myregistry.azurecr.io/xplsg-frontend:latest
              docker tag xplsg-auth-service:latest myregistry.azurecr.io/xplsg-auth-service:latest
            displayName: "Tag Docker Images"

          - script: |
              echo $(ACR_PASSWORD) | docker login myregistry.azurecr.io -u $(ACR_USERNAME) --password-stdin
              docker push myregistry.azurecr.io/xplsg-frontend:latest
              docker push myregistry.azurecr.io/xplsg-auth-service:latest
            displayName: "Push Docker Images to Azure ACR"

  # ================= Deployment to Azure Services ===================
  - stage: Deploy
    displayName: "Deploy to Azure"
    dependsOn: Docker_Build_And_Push
    condition: succeeded()
    
    jobs:
      - job: Deploy_Backend
        displayName: "Deploy Backend to Azure App Service"
        steps:
          - script: |
              az login --service-principal -u $(AZURE_CLIENT_ID) -p $(AZURE_CLIENT_SECRET) --tenant $(AZURE_TENANT_ID)
              az webapp create --resource-group myResourceGroup --plan myAppServicePlan --name xplsg-auth-service --deployment-container-image-name myregistry.azurecr.io/xplsg-auth-service:latest
            displayName: "Deploy Backend to Azure App Service"

      - job: Deploy_Frontend
        displayName: "Deploy Frontend to Azure Static Web Apps"
        steps:
          - script: |
              az login --service-principal -u $(AZURE_CLIENT_ID) -p $(AZURE_CLIENT_SECRET) --tenant $(AZURE_TENANT_ID)
              az staticwebapp create --name xplsg-frontend --resource-group myResourceGroup --location westeurope --source myregistry.azurecr.io/xplsg-frontend:latest
            displayName: "Deploy Frontend to Azure Static Web Apps"
